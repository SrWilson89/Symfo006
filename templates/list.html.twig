{% extends 'base.html.twig' %}

{% block content %}
    <form method="post" class="w-100">
        <div class="card-body">
            
            {# Botones de Añadir y Exportar #}
            <div class="d-flex justify-content-end align-items-center gap-2 flex-wrap">
                <a href="{{ path_to_add }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Añadir
                </a>

                {# Exportación por GET #}
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-file-export"></i> Exportar
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="exportDropdown">
                        <li>
                            <a class="btn btn-outline-danger btn-sm w-100 mb-2" href="{{ path('app_list', app.request.query.all | merge({ entity: entity, format: 'pdf' })) }}">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </a>
                        </li>
                        <li>
                            <a class="btn btn-outline-success btn-sm w-100" href="{{ path('app_list', app.request.query.all | merge({ entity: entity, format: 'excel' })) }}">
                                <i class="fas fa-file-excel"></i> Exportar Excel
                            </a>
                        </li>
                    </ul>
                </div>
                {# FIN Exportación #}

                {# Espacio para el formulario de filtros si lo tienes #}
            </div>
            
            <div class="table-responsive mt-3">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Nombre Completo</th>
                            <th>Rol</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {# CORRECCIÓN 1 (Paginación): Se usa .results en lugar de .items #}
                        {% for row in pagination.results %} 

                            {# CORRECCIÓN 2 (Rutas): Se fuerza el nombre de la entidad a singular para las rutas (ej. 'usuario' en vez de 'usuarios') #}
                            {% set route_entity_name = entity %}
                            {% if entity == 'usuarios' %}
                                {% set route_entity_name = 'usuario' %}
                            {% endif %}
                        
                            {# Enlace de la fila (Línea 58 aprox) #}
                            <tr class="clickable-row" data-href="{{ path('app_edit_' ~ route_entity_name, {'id': row.id}) }}">
                                
                                {# CORRECCIÓN 3 (Propiedad de Entidad): Se usan propiedades reales de App\Entity\User #}
                                <td>{{ row.id }}</td>
                                <td>{{ row.email }}</td>
                                <td>{{ row.nombre }} {{ row.apellidos }}</td>
                                
                                <td>
                                    {% if row.super == 0 %}<span class="badge bg-danger">SUPER</span>
                                    {% elseif row.super == 1 %}<span class="badge bg-warning">ADMIN</span>
                                    {% elseif row.super == 2 %}<span class="badge bg-info">USUARIO</span>
                                    {% else %}<span class="badge bg-secondary">N/D</span>{% endif %}
                                </td>
                                
                                <td class="actions">
                                    <a href="{{ path('app_edit_' ~ route_entity_name, {'id': row.id}) }}" class="on-default edit-row text-primary" title="Editar"><i class="fas fa-pencil-alt"></i></a>
                                    <a href="{{ path('app_delete_' ~ route_entity_name, {'id': row.id}) }}" class="on-default remove-row text-danger" onclick="return confirm('¿Estás seguro de que quieres eliminar el elemento ID: {{ row.id }}?');" title="Eliminar"><i class="far fa-trash-alt"></i></a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {# Paginación #}
            <div class="row pt-3">
                <div class="col-lg-6">
                    {% set from_record = ((pagination.current_page - 1) * pagination.limit) + 1 %}
                    
                    {# CORRECCIÓN 1 (Paginación): Se usa .results|length en lugar de .items|length #}
                    {% set to_record = from_record + pagination.results|length - 1 %}
                    
                    {% set total_records = pagination.total_items %}
                    Mostrando {{ from_record }} a {{ to_record }} de {{ total_records }} registros.
                </div>
                <div class="col-lg-6 text-end">
                    <div class="btn-group">
                        {# Primera y Anterior #}
                        {% if pagination.current_page > 1 %}
                            <a href="?page=1{% if limit %}&limit={{ limit }}{% endif %}" class="btn btn-outline-secondary">Primera</a>
                            <a href="?page={{ pagination.current_page - 1 }}{% if limit %}&limit={{ limit }}{% endif %}" class="btn btn-outline-secondary">Anterior</a>
                        {% endif %}

                        {# Páginas cercanas #}
                        {% set start_page = (pagination.current_page - 2) > 0 ? (pagination.current_page - 2) : 1 %}
                        {% set end_page = (pagination.current_page + 2) < pagination.total_pages ? (pagination.current_page + 2) : pagination.total_pages %}
                        
                        {% for i in start_page..end_page %}
                            <a href="?page={{ i }}{% if limit %}&limit={{ limit }}{% endif %}" class="btn {% if i == pagination.current_page %}btn-primary{% else %}btn-outline-secondary{% endif %}">{{ i }}</a>
                        {% endfor %}

                        {# Puntos suspensivos (si no se muestra la última página) #}
                        {% if end_page < pagination.total_pages - 1 %}
                            <span class="btn btn-outline-secondary disabled">…</span>
                        {% endif %}

                        {# Muestra la última página solo si no está en el rango cercano #}
                        {% if end_page < pagination.total_pages %}
                            <a href="?page={{ pagination.total_pages }}{% if limit %}&limit={{ limit }}{% endif %}" class="btn btn-outline-secondary">{{ pagination.total_pages }}</a>
                        {% endif %}

                        {# Siguiente y Última #}
                        {% if pagination.current_page < pagination.total_pages %}
                            <a href="?page={{ pagination.current_page + 1 }}{% if limit %}&limit={{ limit }}{% endif %}" class="btn btn-outline-secondary">Siguiente</a>
                            <a href="?page={{ pagination.total_pages }}{% if limit %}&limit={{ limit }}{% endif %}" class="btn btn-outline-secondary">Última</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            
        </div>
    </form>
{% endblock %}

{% block specific_vendor %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('tr.clickable-row').forEach(function (row) {
                row.addEventListener('click', function (event) {
                    const href = row.getAttribute('data-href');
                    if (href) {
                        // Impedir la navegación si se hizo clic en un botón de acción (editar/eliminar)
                        if (!event.target.closest('.actions a')) {
                            window.location.href = href;
                        }
                    }
                });
            });
        });
    </script>
{% endblock %}