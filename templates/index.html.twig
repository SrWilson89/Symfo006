{# templates/index.html.twig #}
{% extends 'base.html.twig' %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
    {# Asegúrate de que tienes acceso a app.user antes de usarlo #}
    {% if app.user and app.user.super is defined %}
        {% if app.user.super == 0 or app.user.super == 1 %}
            {# Dashboard para Super Admin o Admin #}
            {% include 'partials/dashboard-widgets.html.twig' %}

            {# Tabla de tareas abiertas y hilo de tareas #}
            <div class="row">
                <div class="col-lg-8">
                    <section class="card">
                        <header class="card-header">
                            <h2 class="card-title">Tareas Abiertas</h2>
                        </header>
                        <div class="card-body">
                            <table class="table table-responsive-md mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Estado</th>
                                        <th>Título</th>
                                        <th>Usuario</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {# La variable que envía el MainController es 'opentasks' #}
                                    {% set openTasksExist = false %}
                                    {% for tarea in opentasks %}
                                        {% set openTasksExist = true %}
                                        <tr>
                                            <td>{{ tarea.id }}</td>
                                            <td><span class="badge badge-primary">{{ tarea.estado.nombre | capitalize }}</span></td>
                                            <td><a href="{{ path('app_edit_tarea', {'id': tarea.id}) }}">{{ tarea.titulo }}</a></td>
                                            <td>{{ tarea.usuario.nombre | default('N/A') }}</td>
                                            <td class="actions">
                                                <a href="{{ path('app_edit_tarea', {'id': tarea.id}) }}" class="on-default edit-row" title="Editar"><i class="fas fa-pencil-alt"></i></a>
                                                <a href="{{ path('app_delete_tarea', {'id': tarea.id}) }}" class="on-default remove-row text-danger" onclick="return confirm('¿Estás seguro de que quieres eliminar la tarea ID: {{ tarea.id }}?');" title="Eliminar"><i class="far fa-trash-alt"></i></a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% if not openTasksExist %}
                                <div class="alert alert-info">No hay tareas abiertas.</div>
                            {% endif %}
                        </div>
                    </section>
                </div>
                <div class="col-lg-4">
                    {% include 'partials/hilos-widget.html.twig' %}
                </div>
            </div>

            {% include 'partials/dashboard-charts.html.twig' %}

        {% else %}
            {# Dashboard para usuarios normales (si aplica) #}
            <h2>Bienvenido, {{ app.user.nombre }}.</h2>
            {# Aquí puedes incluir código específico para usuarios no administradores #}
        {% endif %}
    {% else %}
        {# Manejo si no hay usuario autenticado (aunque el security.yaml lo debería evitar) #}
        <p>Por favor, inicie sesión.</p>
    {% endif %}
{% endblock %}

{% block javascripts %}
    {# Aquí van tus scripts para el Dashboard #}
{% endblock %}