{# templates/index.html.twig #}
{% extends 'base.html.twig' %}

{% block head %}
    <!-- Mantener tu script de Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- IMPORTANTE: El bloque <style> inline ha sido eliminado. Sus estilos están ahora en 'custom.css' -->
{% endblock %}

{% block content %}
    {# Asegúrate de que tienes acceso a app.user antes de usarlo #}
    {% if app.user and app.user.super is defined %}
        {% if app.user.super == 0 or app.user.super == 1 %}
            {# Dashboard para Super Admin o Admin #}
            {% include 'partials/dashboard-widgets.html.twig' %}

            {# Tabla de tareas abiertas y hilo de tareas #}
            <div class="row">
                <div class="col-lg-8">
                    {# APLICAMOS 'card-modern' a la tarjeta principal de tareas #}
                    <section class="card card-modern"> 
                        <header class="card-header">
                            <h2 class="card-title">Tareas Abiertas</h2>
                        </header>
                        <div class="card-body">
                            {# APLICAMOS 'table-striped-modern' a la tabla y 'table-actions' a las celdas de acciones #}
                            <table class="table table-responsive-md mb-0 table-striped-modern"> 
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Estado</th>
                                        <th>Título</th>
                                        <th>Usuario</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {# La variable 'openTasks' debe estar disponible para la plantilla #}
                                    {% set openTasksExist = false %}
                                    {% for tarea in openTasks|default([]) %}
                                        {% set openTasksExist = true %}
                                        <tr>
                                            <td>{{ tarea.id }}</td>
                                            <td><span class="badge bg-primary">{{ tarea.estado }}</span></td>
                                            <td>{{ tarea.titulo }}</td>
                                            <td>{{ tarea.usuario.nombre }}</td>
                                            <td class="table-actions"> 
                                                <a href="{{ path('app_view_tarea', {'id': tarea.id}) }}" class="on-default edit-row text-info" title="Ver/Editar"><i class="far fa-edit"></i></a>
                                                <a href="{{ path('app_delete_tarea', {'id': tarea.id}) }}" class="on-default remove-row text-danger" onclick="return confirm('¿Estás seguro de que quieres eliminar la tarea ID: {{ tarea.id }}?');" title="Eliminar"><i class="far fa-trash-alt"></i></a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% if not openTasksExist %}
                                <div class="alert alert-info mt-3">No hay tareas abiertas.</div>
                            {% endif %}
                        </div>
                    </section>
                </div>
                <div class="col-lg-4">
                    {% include 'partials/hilos-widget.html.twig' %}
                </div>
            </div>

            {% include 'partials/dashboard-charts.html.twig' %}

        {% else %}
            {# Dashboard para usuarios normales (si aplica) #}
            <h2>Bienvenido, {{ app.user.nombre }}.</h2>
            {# Aquí puedes incluir código específico para usuarios no administradores #}
        {% endif %}
    {% else %}
        {# Manejo si no hay usuario autenticado (aunque el security.yaml lo debería evitar) #}
        <p>Por favor, inicie sesión.</p>
    {% endif %}
{% endblock %}

{% block javascripts %}
    {# Aquí van tus scripts para el Dashboard #}
{% endblock %}