{# templates/partials/dashboard-charts.html.twig #}
<div class="row mt-4">
    <div class="col-lg-12">
        <section class="card">
            <header class="card-header">
                <h2 class="card-title">Actividad Mensual (Últimos 12 Meses)</h2>
            </header>
            <div class="card-body">
                <div class="chart-container" style="height: 350px;">
                    <canvas id="monthlyActivityChart"></canvas>
                </div>
            </div>
        </section>
    </div>
</div>

<script>
    // Se ejecuta una vez el DOM esté cargado.
    document.addEventListener('DOMContentLoaded', function() {
        // Obtenemos los datos del gráfico pasados desde el MainController
        const graficoData = {{ resume.grafico | json_encode | raw }};

        const labels = graficoData.labels;
        const newCustomers = graficoData.newCustomers;
        const newTasks = graficoData.newTasks;
        const sales = graficoData.sales;

        const ctx = document.getElementById('monthlyActivityChart');

        if (ctx) {
            new Chart(ctx, {
                type: 'bar', // Tipo de gráfico base: barras
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ventas (€)',
                            data: sales,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)', // Verde/Teal
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            type: 'line', // Usar línea para ventas
                            yAxisID: 'y-sales',
                            tension: 0.3,
                            pointRadius: 3,
                            order: 1 // Primero la línea de ventas
                        },
                        {
                            label: 'Nuevos Clientes',
                            data: newCustomers,
                            backgroundColor: 'rgba(0, 136, 204, 0.7)', // Azul primario
                            borderColor: 'rgba(0, 136, 204, 1)',
                            borderWidth: 1,
                            yAxisID: 'y-count',
                            stack: 'activity',
                            order: 2 // Segundo las barras de clientes
                        },
                        {
                            label: 'Nuevas Tareas',
                            data: newTasks,
                            backgroundColor: 'rgba(255, 99, 132, 0.7)', // Rojo
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1,
                            yAxisID: 'y-count',
                            stack: 'activity',
                            order: 2 // Tercero las barras de tareas (apiladas con clientes)
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        'y-count': {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Conteo (Clientes/Tareas)'
                            },
                            beginAtZero: true
                        },
                        'y-sales': {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: 'Ventas (€)'
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';

                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.label === 'Ventas (€)') {
                                        // Formatear como moneda
                                        label += new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(context.parsed.y);
                                    } else {
                                        // Formatear como número entero
                                        label += context.parsed.y;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
    });
</script>